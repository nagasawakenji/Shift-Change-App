<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚·ãƒ•ãƒˆãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* iOSã£ã½ã„ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ã®èƒŒæ™¯å›ºå®š */
        body.modal-open { overflow: hidden; }
    </style>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 pb-20">

<header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
        <h1 class="text-lg font-bold text-gray-800">
            <i class="fa-solid fa-store text-blue-500 mr-2"></i>{{.Group.Name}}
        </h1>
        <div class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
            <i class="fa-solid fa-user-tag mr-1"></i>{{.User.DisplayName}}
        </div>
    </div>
</header>

<main class="max-w-md mx-auto p-4 space-y-4">

    <div class="flex justify-between items-end">
        <h2 class="text-sm font-bold text-gray-500 uppercase tracking-wider">å‹Ÿé›†ä¸­ ({{len .Trades}}ä»¶)</h2>
    </div>

    <div id="trade-list" class="space-y-3">
        {{range .Trades}}
        <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-1.5 h-full bg-blue-500"></div>

            <div class="flex justify-between items-start pl-2">
                <div>
                    <div class="text-xl font-bold text-gray-800 flex items-center">
                        <span class="shift-time">{{ .ShiftStartAt.Format "2006-01-02T15:04:05Z07:00" }}</span>
                        <span class="mx-1 text-gray-400 text-sm">~</span>
                        <span class="shift-time text-base text-gray-600">{{ .ShiftEndAt.Format "2006-01-02T15:04:05Z07:00" }}</span>
                    </div>
                    <div class="flex items-center mt-2">
                        <div class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-xs text-gray-500 mr-2">
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <span class="text-sm text-gray-600 font-medium">{{.RequesterName}}</span>
                    </div>
                    <div class="mt-2 text-sm text-orange-500 font-bold">
                        <i class="fa-solid fa-gift mr-1"></i> {{.BountyDescription}}
                    </div>
                </div>

                <div class="flex flex-col gap-2 items-end">
                    <a href="/groups/{{$.GroupID}}/trades/{{.ID}}?user_id={{$.CurrentUserID}}" class="bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-bold py-2 px-3 rounded-lg shadow-sm transition">
                        <i class="fa-solid fa-circle-info mr-1"></i> è©³ç´°
                    </a>

                    <button onclick="acceptTrade('{{.ID}}')" class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-md transition transform active:scale-95">
                        ä»£ã‚ã‚‹
                    </button>
                </div>
            </div>
        </div>
        {{else}}
        <div class="text-center py-10 text-gray-400">
            <i class="fa-regular fa-calendar-check text-4xl mb-3"></i>
            <p>ç¾åœ¨å‹Ÿé›†ä¸­ã®ã‚·ãƒ•ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>
        </div>
        {{end}}
    </div>

    <div class="flex justify-between items-end mb-3">
        <h2 class="text-sm font-bold text-gray-500 uppercase tracking-wider">
            <i class="fa-solid fa-clock-rotate-left mr-1"></i> è‡ªåˆ†ã®å±¥æ­´
        </h2>
    </div>

    <div class="space-y-3 pb-20">
        {{range .MyTrades}}
        <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
            <div class="flex justify-between items-center mb-2">
                    <span class='text-xs font-bold px-2 py-1 rounded
                        {{if eq .Status "OPEN"}}bg-green-100 text-green-800{{else}}bg-gray-200 text-gray-600{{end}}'>
                {{.Status}}
                </span>
                <span class="text-xs text-gray-400 shift-time">{{ .ShiftStartAt.Format "2006-01-02T15:04:05Z07:00" }}</span>
            </div>

            <div class="flex justify-between items-center">
                <div>
                    <div class="text-sm font-bold text-gray-800">{{.BountyDescription}}</div>

                    {{if .IsPaid}}
                    <div class="text-green-600 text-xs font-bold mt-1">
                        <i class="fa-solid fa-check-circle"></i> æ”¯æ‰•ã„å®Œäº†
                    </div>
                    {{else}}
                    <div class="text-red-500 text-xs font-bold mt-1">
                        <i class="fa-solid fa-circle-exclamation"></i> æœªæ‰•ã„
                    </div>
                    {{end}}
                </div>

                <div class="flex gap-2 items-center">
                    {{/* OPEN ã®å‹Ÿé›†ã¯å–ã‚Šæ¶ˆã—ï¼ˆå‰Šé™¤ï¼‰ã§ãã‚‹ */}}
                    {{if eq .Status "OPEN"}}
                    <button onclick="deleteTrade('{{.ID}}', '{{.RequesterID}}')"
                            class="bg-red-500 text-white text-xs font-bold py-2 px-3 rounded shadow hover:bg-red-600">
                        <i class="fa-solid fa-trash"></i> å‰Šé™¤
                    </button>
                    {{end}}

                    {{/* FILLED ã§æœªæ‰•ã„ã‹ã¤ãƒªã‚¯ã‚¨ã‚¹ã‚¿ãƒ¼æœ¬äººã®ã¿æ”¯æ‰•ã„ãƒœã‚¿ãƒ³ */}}
                    {{if and (not .IsPaid) (eq .Status "FILLED") (eq (printf "%v" .RequesterID) $.CurrentUserID)}}
                    <button onclick="markAsPaid('{{.ID}}', '{{.RequesterID}}')"
                            class="bg-orange-500 text-white text-xs font-bold py-2 px-3 rounded shadow hover:bg-orange-600">
                        <i class="fa-solid fa-yen-sign"></i> æ”¯æ‰•ã„å®Œäº†
                    </button>
                    {{end}}
                </div>
            </div>
        </div>
        {{else}}
        <div class="text-center text-xs text-gray-400">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>
        {{end}}
    </div>


</main>

<button onclick="openModal()" class="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-blue-700 transition transform active:scale-90 z-20">
    <i class="fa-solid fa-plus"></i>
</button>

<div id="post-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl transform transition-all scale-100">
        <h3 class="text-lg font-bold mb-4 flex items-center">
            <i class="fa-solid fa-bullhorn text-blue-500 mr-2"></i> ã‚·ãƒ•ãƒˆå‹Ÿé›†ã‚’ä½œæˆ
        </h3>

        <form id="create-trade-form" class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">é–‹å§‹æ—¥æ™‚</label>
                <input type="datetime-local" id="start_at" required class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">çµ‚äº†æ—¥æ™‚</label>
                <input type="datetime-local" id="end_at" required class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ãŠç¤¼ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆ</label>
                <input type="text" id="bounty" placeholder="ä¾‹: ã‚¹ã‚¿ãƒå¥¢ã‚Šã¾ã™ï¼" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-sm focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="flex gap-3 mt-6">
                <button type="button" onclick="closeModal()" class="flex-1 py-2.5 bg-gray-100 text-gray-700 font-bold rounded-lg hover:bg-gray-200">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="submit" class="flex-1 py-2.5 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-md">
                    å‹Ÿé›†ã™ã‚‹
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    const GROUP_ID = "{{.GroupID}}";
    const USER_ID = "{{.CurrentUserID}}";
    const LIFF_ID = "{{.LiffID}}";
    let ID_TOKEN = "";

    async function initAuth() {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
            liff.login();
            return;
        }

        ID_TOKEN = liff.getIDToken();
        if (!ID_TOKEN) {
            alert("id_token ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆLIFFã® scope ã« openid ãŒå¿…è¦ã§ã™ï¼‰");
        }
    }

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰ã§èªè¨¼åˆæœŸåŒ–
    window.addEventListener("load", initAuth);

    // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆèª¿æ•´
    // Go/DB ã‹ã‚‰æ¥ã‚‹æ–‡å­—åˆ—ã¯ RFC3339 å½¢å¼ãªã®ã§ãã®ã¾ã¾ Date ãƒ‘ãƒ¼ã‚¹ã™ã‚‹
    function parseToDate(value) {
        if (!value) return null;
        const s = String(value).trim();
        const d = new Date(s); // RFC3339 ã‚’ãã®ã¾ã¾ãƒ‘ãƒ¼ã‚¹
        if (Number.isNaN(d.getTime())) return null;
        return d;
    }

    const fmtJST = new Intl.DateTimeFormat('ja-JP', {
        timeZone: 'Asia/Tokyo',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false,
    });

    document.querySelectorAll('.shift-time').forEach(el => {
        const raw = (el.textContent || '').trim();
        const d = parseToDate(raw);
        if (!d) return;
        el.textContent = fmtJST.format(d);
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
    function openModal() {
        document.getElementById('post-modal').classList.remove('hidden');
    }
    function closeModal() {
        document.getElementById('post-modal').classList.add('hidden');
    }
    function requireIDToken() {
        if (!ID_TOKEN) {
            alert("èªè¨¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚LINEå†…ã‹ã‚‰é–‹ãç›´ã—ã¦ãã ã•ã„ã€‚");
            throw new Error("missing id_token");
        }
    }

    // ã‚·ãƒ•ãƒˆå¿œå‹Ÿ (PUT)
    async function acceptTrade(tradeID) {
        if(!confirm("æœ¬å½“ã«ã“ã®ã‚·ãƒ•ãƒˆã‚’ä»£ã‚ã‚Šã¾ã™ã‹ï¼Ÿ")) return;

        try {
            requireIDToken();

            const res = await fetch(`/api/groups/${GROUP_ID}/trades/${tradeID}/accept`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${ID_TOKEN}`
                },
                body: JSON.stringify({})
            });

            if (!res.ok) {
                const err = await res.json();
                alert("ã‚¨ãƒ©ãƒ¼: " + (err.error || "å¤±æ•—ã—ã¾ã—ãŸ"));
                return;
            }
            alert("ã‚·ãƒ•ãƒˆæˆç«‹ï¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ğŸ‰");
            location.reload(); // ç”»é¢æ›´æ–°

        } catch (e) {
            alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        }
    }

    // ã‚·ãƒ•ãƒˆä½œæˆ (POST)
    document.getElementById('create-trade-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        // ISOæ–‡å­—åˆ—ã¸ã®å¤‰æ›
        const startAt = new Date(document.getElementById('start_at').value).toISOString();
        const endAt = new Date(document.getElementById('end_at').value).toISOString();
        const bounty = document.getElementById('bounty').value;

        try {
            requireIDToken();

            const res = await fetch(`/api/groups/${GROUP_ID}/trades`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${ID_TOKEN}`
                },
                body: JSON.stringify({
                    start_at: startAt,
                    end_at: endAt,
                    bounty: bounty
                })
            });

            if (!res.ok) {
                const err = await res.json();
                alert("ã‚¨ãƒ©ãƒ¼: " + (err.error || "ä½œæˆã§ãã¾ã›ã‚“ã§ã—ãŸ"));
                return;
            }

            alert("å‹Ÿé›†ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼");
            location.reload();

        } catch (e) {
            alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            console.error(e);
        }
    });

    // æ”¯æ‰•ã„å®Œäº†å‡¦ç† (PUT) â†’ body ã« id_token
    async function markAsPaid(tradeID, requesterID) {
        // UIä¸Šã®ç°¡æ˜“ãƒã‚§ãƒƒã‚¯ã¯æ®‹ã—ã¦OKï¼ˆã§ã‚‚æœ¬å½“ã®èªå¯ã¯ã‚µãƒ¼ãƒå´ãŒã‚„ã‚‹ï¼‰
        if (requesterID !== USER_ID) {
            return;
        }
        if(!confirm("è¬ç¤¼ã®æ”¯æ‰•ã„ã‚’å®Œäº†æ¸ˆã¿ã«ã—ã¾ã™ã‹ï¼Ÿ")) return;

        try {
            requireIDToken();

            const res = await fetch(`/api/trades/${tradeID}/paid`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${ID_TOKEN}`
                },
                body: JSON.stringify({})
            });

            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (err.error || ""));
                return;
            }

            alert("æ”¯æ‰•ã„ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼");
            location.reload();
        } catch (e) {
            console.error(e);
            alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼");
        }
    }

    // ã‚·ãƒ•ãƒˆå‹Ÿé›†ã®å‰Šé™¤ (DELETE)
    async function deleteTrade(tradeID, requesterID) {
        // UIä¸Šã®ç°¡æ˜“ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€çµ‚çš„ãªèªå¯ã¯ã‚µãƒ¼ãƒå´ï¼‰
        if (requesterID !== USER_ID) {
            return;
        }

        if (!confirm("ã“ã®å‹Ÿé›†ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

        try {
            requireIDToken();

            const url = `/api/groups/${GROUP_ID}/trades/${tradeID}`;
            const res = await fetch(url, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${ID_TOKEN}`
                }
            });

            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (err.error || ""));
                return;
            }

            alert("å‰Šé™¤ã—ã¾ã—ãŸ");
            location.reload();
        } catch (e) {
            console.error(e);
            alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼");
        }
    }
</script>
</body>
</html>