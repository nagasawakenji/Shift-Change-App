<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‹Ÿé›†è©³ç´°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 pb-20">

<header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="max-w-md mx-auto px-4 py-3 flex items-center gap-3">
        <div class="font-bold truncate">{{.Group.Name}}</div>
    </div>
</header>

<main class="max-w-md mx-auto p-4 space-y-4">
    <!-- è¿½è¨˜å°ç·šï¼ˆæœ€ä¸Šéƒ¨ï¼‰ -->
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
        <div class="text-xs font-bold text-gray-500 mb-2">è©³ç´°ï¼ˆä»»æ„ï¼‰</div>

        {{/* ä½œæˆè€…ã ã‘ç·¨é›†UIã‚’è¡¨ç¤º: Goå´ã§ CanEditDetails(bool) ã‚’æ¸¡ã™ */}}

        {{if .CanEditDetails}}
        <textarea id="details" class="w-full bg-gray-50 border rounded-lg p-2 text-sm" rows="4"
                  placeholder="ä¾‹ï¼‰æ¥­å‹™å†…å®¹ï¼šãƒ¬ã‚¸ä¸­å¿ƒã€å¼•ãç¶™ãï¼š17æ™‚ã«ç´å“å¯¾å¿œãŒã‚ã‚Šã¾ã™">{{.Trade.Details}}</textarea>

        <div class="flex justify-end mt-2">
            <button onclick="saveDetails()" class="bg-blue-600 text-white text-sm font-bold px-4 py-2 rounded-lg shadow">
                ä¿å­˜
            </button>
        </div>
        {{else}}
        <div class="text-sm text-gray-700 whitespace-pre-wrap">{{if .Trade.Details}}{{.Trade.Details}}{{else}}ï¼ˆè©³ç´°ã¯æœªè¨˜å…¥ã§ã™ï¼‰{{end}}</div>
        {{end}}

        <div class="text-xs text-gray-400 mt-2">
            â€» ã¾ãšã¯æ—¥æ™‚ãƒ»è¬ç¤¼ã ã‘ã§å‹Ÿé›† â†’ æˆç«‹å¾Œã«è¿½è¨˜ã§ã‚‚OK
        </div>
    </div>

    <!-- åŸºæœ¬æƒ…å ± -->
    <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
        <div class="text-sm font-bold mb-2">ã‚·ãƒ•ãƒˆ</div>
        <div class="text-lg font-bold">
            <span class="shift-time">{{ .Trade.ShiftStartAt.Format "2006-01-02T15:04:05Z07:00" }}</span>
            <span class="text-gray-400 mx-1">~</span>
            <span class="shift-time">{{ .Trade.ShiftEndAt.Format "2006-01-02T15:04:05Z07:00" }}</span>
        </div>
        <div class="mt-2 text-sm text-orange-500 font-bold">
            ğŸ {{.Trade.BountyDescription}}
        </div>
    </div>
</main>

<script>
    const GROUP_ID = "{{.GroupID}}";
    const TRADE_ID = "{{.Trade.ID}}";
    const LIFF_ID = "{{.LiffID}}";
    let ID_TOKEN = "";
    const CAN_EDIT = "{{.CanEditDetails}}" === "true";

    async function initAuth() {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        ID_TOKEN = liff.getIDToken();
    }

    // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆèª¿æ•´
    // Go/DB ã‹ã‚‰æ¥ã‚‹æ–‡å­—åˆ—ã¯ RFC3339 å½¢å¼ãªã®ã§ãã®ã¾ã¾ Date ãƒ‘ãƒ¼ã‚¹ã™ã‚‹
    function parseToDate(value) {
        if (!value) return null;
        const s = String(value).trim();
        const d = new Date(s); // RFC3339 ã‚’ãã®ã¾ã¾ãƒ‘ãƒ¼ã‚¹
        if (Number.isNaN(d.getTime())) return null;
        return d;
    }

    const fmtJST = new Intl.DateTimeFormat('ja-JP', {
        timeZone: 'Asia/Tokyo',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false,
    });

    function applyJSTShiftTimes() {
        document.querySelectorAll('.shift-time').forEach(el => {
            const raw = (el.textContent || '').trim();
            const d = parseToDate(raw);
            if (!d) return;
            el.textContent = fmtJST.format(d);
        });
    }

    window.addEventListener("load", () => {
        applyJSTShiftTimes();
        if (CAN_EDIT) initAuth();
    });

    function requireIDToken() {
        if (!ID_TOKEN) { alert("èªè¨¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“"); throw new Error("missing id_token"); }
    }

    async function saveDetails() {
        try {
            requireIDToken();
            const details = document.getElementById("details").value || "";

            const res = await fetch(`/api/groups/${GROUP_ID}/trades/${TRADE_ID}/details`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${ID_TOKEN}`
                },
                body: JSON.stringify({ details })
            });

            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (err.error || ""));
                return;
            }
            alert("ä¿å­˜ã—ã¾ã—ãŸ");
        } catch (e) {
            console.error(e);
            alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼");
        }
    }
</script>
</body>
</html>